<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教會服事班表 - 查看</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 唯讀樣式 */
        .service-cell {
            cursor: default !important;
        }

        .service-cell:hover {
            background: white !important;
        }

        .person-chip {
            cursor: default;
        }

        .schedule-table th.service-header {
            cursor: default;
        }

        .header-section {
            justify-content: center;
        }

        .control-actions {
            display: none;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="header-section">
            <div class="app-title">
                <h1 style="display: inline;">⛪ <span id="collectionTitle">教會服事班表</span></h1>
            </div>
            <!-- 分組過濾器 -->
            <div class="group-filter" id="groupFilter" style="display: none;">
                <!-- 動態生成 -->
            </div>
            <div class="status-indicator">
            </div>
        </div>

        <div class="table-container">
            <div class="table-scroll">
                <table class="schedule-table" id="scheduleTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js';
        import { getFirestore, collection, doc, getDocs, getDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { firebaseConfig, COLLECTION_NAME } from './firebase-config.js';

        // 從 URL 參數取得 collection 名稱
        const urlParams = new URLSearchParams(window.location.search);
        const collectionName = urlParams.get('collection') || '';

        // 顯示錯誤頁面
        function showError(title, message) {
            document.querySelector('.app-container').innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50vh; text-align: center;">
                    <h1 style="color: #ef4444; font-size: 48px; margin-bottom: 16px;">⚠️</h1>
                    <h2 style="color: #ef4444; margin-bottom: 8px;">${title}</h2>
                    <p style="color: #64748b;">${message}</p>
                    <a href="index.html" class="btn btn-primary" style="margin-top: 24px;">返回選擇頁面</a>
                </div>
            `;
        }

        // 顏色陣列
        const PERSON_CHIP_COLORS = [
            '#E74C3C', '#3498DB', '#2ECC71', '#9B59B6', '#F39C12',
            '#1ABC9C', '#E91E63', '#00BCD4', '#8BC34A', '#FF5722',
            '#673AB7', '#009688', '#CDDC39', '#795548', '#607D8B',
            '#FF9800', '#4CAF50', '#2196F3', '#F44336', '#9C27B0',
            '#00ACC1', '#7CB342', '#C0392B', '#D35400', '#16A085',
            '#8E44AD', '#27AE60', '#2980B9', '#F1C40F', '#34495E'
        ];

        let scheduleData = [];
        let expiredData = []; // 過期資料
        let serviceItems = [];
        let personColorMap = new Map();
        let allPersonNames = new Set();
        let displayConfig = null;
        let visibleGroups = {}; // 記錄各群組的顯示狀態
        let showExpired = false; // 是否顯示過期資料
        let db = null; // Firebase db 參考

        async function init() {
            try {
                const app = initializeApp(firebaseConfig);

                // 初始化 App Check
                const appCheck = initializeAppCheck(app, {
                    provider: new ReCaptchaV3Provider('6LcrTEgsAAAAALHsL8i7xFOrUM4t4q5j1gVftmAx'),
                    isTokenAutoRefreshEnabled: true
                });

                db = getFirestore(app);

                // 驗證 collection 是否有效
                const serve = await loadAndValidateCollection(db);
                if (!serve) {
                    return; // 驗證失敗，showError 已顯示錯誤訊息
                }

                // 更新頁面標題
                document.getElementById('collectionTitle').textContent = serve.name + '班表';
                document.title = `${serve.name}班表 - 查看`;

                // 載入資料
                await loadData(db);

                // 載入過期資料
                await loadExpiredData(db);

                // 建立顏色映射
                buildColorMap();

                // 載入分組設定並初始化過濾器
                await loadDisplayConfig(db);
                initGroupFilter();

                // 渲染表格
                renderTable();
            } catch (error) {
                console.error('初始化失敗:', error);
            }
        }

        // 載入崇拜列表並驗證
        async function loadAndValidateCollection(db) {
            const serveListRef = doc(db, '_config', 'serve-list');
            const serveListDoc = await getDoc(serveListRef);

            if (!serveListDoc.exists()) {
                showError('尚未設定', '請先到管理頁面新增崇拜');
                return null;
            }

            const serveList = serveListDoc.data().serves || [];
            if (serveList.length === 0) {
                showError('尚未設定', '請先到管理頁面新增崇拜');
                return null;
            }

            // 檢查 collection 是否有效
            const serve = serveList.find(s => s.id === collectionName);
            if (!serve) {
                showError('找不到班表', `無效的班表名稱: ${collectionName || '(未指定)'}`);
                return null;
            }

            return serve;
        }

        async function loadData(db) {
            // 載入 metadata
            const metadataRef = doc(db, collectionName, '_metadata');
            const metadataDoc = await getDoc(metadataRef);
            if (metadataDoc.exists()) {
                serviceItems = metadataDoc.data().serviceItems || [];
            }

            // 載入班表資料
            const snapshot = await getDocs(collection(db, collectionName));
            scheduleData = [];

            snapshot.forEach(doc => {
                if (doc.id !== '_metadata') {
                    const data = doc.data();
                    scheduleData.push({ date: doc.id, ...data });

                    // 收集人名
                    serviceItems.forEach(service => {
                        if (data[service]) {
                            data[service].forEach(name => allPersonNames.add(name));
                        }
                    });
                }
            });

            // 按日期排序
            scheduleData.sort((a, b) => a.date.localeCompare(b.date));
        }

        // 載入過期資料（最後5筆）
        async function loadExpiredData(db) {
            const expiredCollectionName = `Expired-${collectionName}`;
            try {
                const snapshot = await getDocs(collection(db, expiredCollectionName));
                expiredData = [];

                snapshot.forEach(docRef => {
                    if (docRef.id !== '_metadata') {
                        const data = docRef.data();
                        expiredData.push({ date: docRef.id, ...data });
                    }
                });

                // 按日期排序（新到舊），取最後5筆
                expiredData.sort((a, b) => b.date.localeCompare(a.date));
                expiredData = expiredData.slice(0, 5);
                // 反轉回舊到新的順序（顯示時先顯示舊的）
                expiredData.reverse();
            } catch (error) {
                console.log('無過期資料或載入失敗:', error);
                expiredData = [];
            }
        }

        function buildColorMap() {
            const sortedNames = Array.from(allPersonNames).sort();
            sortedNames.forEach((name, index) => {
                personColorMap.set(name, PERSON_CHIP_COLORS[index % PERSON_CHIP_COLORS.length]);
            });
        }

        function getPersonColor(name) {
            return personColorMap.get(name) || '#888888';
        }

        function renderTable() {
            renderTableHead();
            renderTableBody();
        }

        // 載入分組設定
        async function loadDisplayConfig(db) {
            try {
                const metadataRef = doc(db, collectionName, '_metadata');
                const metadataDoc = await getDoc(metadataRef);

                if (metadataDoc.exists() && metadataDoc.data().displayConfig) {
                    displayConfig = metadataDoc.data().displayConfig;
                } else {
                    displayConfig = null;
                }
            } catch (error) {
                console.error('載入分組設定失敗:', error);
            }
        }

        // 初始化分組過濾器
        function initGroupFilter() {
            const filterContainer = document.getElementById('groupFilter');
            let html = '';
            let hasContent = false;

            // 檢查是否有分組設定且有非 ungrouped 的群組
            if (displayConfig && displayConfig.groups) {
                const nonUngroupedGroups = displayConfig.groups.filter(g => g.id !== 'ungrouped' && g.items.length > 0);

                if (nonUngroupedGroups.length > 0) {
                    hasContent = true;

                    // 初始化各群組的顯示狀態
                    displayConfig.groups.forEach(group => {
                        visibleGroups[group.id] = group.defaultVisible !== false;
                    });

                    // 渲染分組 checkbox
                    nonUngroupedGroups.forEach(group => {
                        const checked = visibleGroups[group.id] ? 'checked' : '';
                        html += `
                            <label class="group-filter-item">
                                <input type="checkbox" ${checked} data-group-id="${group.id}" onchange="window.handleGroupFilterChange(this)">
                                ${group.name}
                            </label>
                        `;
                    });
                }
            }

            // 如果有過期資料，新增「顯示前5週」選項
            if (expiredData.length > 0) {
                hasContent = true;
                const separator = html ? 'style="margin-left: 16px; border-left: 1px solid #ddd; padding-left: 16px;"' : '';
                html += `
                    <label class="group-filter-item" ${separator}>
                        <input type="checkbox" id="showExpiredCheckbox" onchange="window.handleShowExpiredChange(this)">
                        顯示前5週
                    </label>
                `;
            }

            if (hasContent) {
                filterContainer.style.display = 'flex';
                filterContainer.innerHTML = html;
            } else {
                filterContainer.style.display = 'none';
            }
        }

        // 處理顯示過期資料變更
        window.handleShowExpiredChange = function (checkbox) {
            showExpired = checkbox.checked;
            renderTable();
        };

        // 處理群組過濾器變更
        window.handleGroupFilterChange = function (checkbox) {
            const groupId = checkbox.dataset.groupId;
            visibleGroups[groupId] = checkbox.checked;
            renderTable();
        };

        // 取得可見的服事項目
        function getVisibleServiceItems() {
            if (!displayConfig || !displayConfig.groups) {
                return serviceItems;
            }

            const visible = [];
            const hidden = displayConfig.hidden || [];
            let ungroupedItems = [];

            // 先處理非 ungrouped 群組
            displayConfig.groups.forEach(group => {
                if (group.id === 'ungrouped') {
                    // 儲存 ungrouped 項目稍後處理
                    ungroupedItems = group.items.filter(item => !hidden.includes(item));
                } else if (visibleGroups[group.id]) {
                    // 其他群組根據勾選狀態加入
                    visible.push(...group.items.filter(item => !hidden.includes(item)));
                }
            });

            // 最後加入未分組的項目
            visible.push(...ungroupedItems);

            return visible;
        }

        // 更新的 renderTableHead
        function renderTableHead() {
            const thead = document.getElementById('tableHead');
            const visibleItems = getVisibleServiceItems();

            let html = '<tr><th class="date-header">日期</th>';
            visibleItems.forEach(item => {
                html += `<th class="service-header">${item}</th>`;
            });
            html += '</tr>';
            thead.innerHTML = html;
        }

        // 更新的 renderTableBody
        // 更新的 renderTableBody
        function renderTableBody() {
            const tbody = document.getElementById('tableBody');
            const visibleItems = getVisibleServiceItems();
            const highlightUser = urlParams.get('user');
            let html = '';

            // 組合要顯示的資料
            let dataToShow = [];
            if (showExpired && expiredData.length > 0) {
                dataToShow = [...expiredData, ...scheduleData];
            } else {
                dataToShow = scheduleData;
            }

            dataToShow.forEach((row, index) => {
                // 過期資料添加淡化樣式
                const isExpired = showExpired && index < expiredData.length;
                const rowStyle = isExpired ? 'opacity: 0.6; background: #f8fafc;' : '';

                html += `<tr style="${rowStyle}">`;
                html += `<td><div class="date-cell">${row.date}</div></td>`;

                visibleItems.forEach(item => {
                    const persons = row[item] || [];
                    const personText = persons.join('/');
                    let cellStyle = '';

                    // 如果有指定 user 且內容包含該 user，則 highlight
                    if (highlightUser && personText.includes(highlightUser)) {
                        cellStyle = 'background-color: #ffe08a;'; // Yellow highlight
                    }

                    html += `<td class="service-cell" style="${cellStyle}">`;
                    if (persons.length > 0) {
                        // 簡化顯示：文字用 / 連接
                        html += `<span style="font-weight: 550">${personText}</span>`;
                    }
                    html += '</td>';
                });

                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        init();
    </script>
</body>

</html>