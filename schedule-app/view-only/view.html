<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教會服事班表 - 查看</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* 唯讀樣式 */
        .service-cell {
            cursor: default !important;
        }

        .service-cell:hover {
            background: white !important;
        }

        .person-chip {
            cursor: default;
        }

        .schedule-table th.service-header {
            cursor: default;
        }

        .header-section {
            justify-content: center;
        }

        .control-actions {
            display: none;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="header-section">
            <div class="app-title">
                <h1 style="display: inline;">⛪ <span id="collectionTitle">教會服事班表</span></h1>
            </div>
            <div class="status-indicator">
            </div>
        </div>

        <!-- 分組過濾器 -->
        <div class="group-filter" id="groupFilter" style="display: none;">
            <!-- 動態生成 -->
        </div>

        <div class="table-container">
            <div class="table-scroll">
                <table class="schedule-table" id="scheduleTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, getDocs, getDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { firebaseConfig, COLLECTION_NAME } from '../firebase-config.js';

        // 從 URL 參數取得 collection 名稱
        const urlParams = new URLSearchParams(window.location.search);
        const collectionName = urlParams.get('collection') || '';

        // 有效的 collection 列表
        const VALID_COLLECTIONS = ['youth-serve', 'kids-serve', 'adult-serve'];

        // Collection 名稱對照表
        const COLLECTION_DISPLAY_NAMES = {
            'youth-serve': '青年崇拜班表',
            'kids-serve': '兒童崇拜班表',
            'adult-serve': '成人崇拜班表'
        };

        // 驗證 collection 是否有效
        if (!VALID_COLLECTIONS.includes(collectionName)) {
            document.querySelector('.app-container').innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50vh; text-align: center;">
                    <h1 style="color: #ef4444; font-size: 48px; margin-bottom: 16px;">⚠️</h1>
                    <h2 style="color: #ef4444; margin-bottom: 8px;">Error: Dataset not found</h2>
                    <p style="color: #64748b;">無效的班表名稱: ${collectionName || '(未指定)'}</p>
                    <a href="index.html" class="btn btn-primary" style="margin-top: 24px;">返回選擇頁面</a>
                </div>
            `;
            throw new Error('Invalid collection');
        }

        // 更新頁面標題
        const displayName = COLLECTION_DISPLAY_NAMES[collectionName];
        document.getElementById('collectionTitle').textContent = displayName;
        document.title = `${displayName} - 查看`;

        // 顏色陣列
        const PERSON_CHIP_COLORS = [
            '#E74C3C', '#3498DB', '#2ECC71', '#9B59B6', '#F39C12',
            '#1ABC9C', '#E91E63', '#00BCD4', '#8BC34A', '#FF5722',
            '#673AB7', '#009688', '#CDDC39', '#795548', '#607D8B',
            '#FF9800', '#4CAF50', '#2196F3', '#F44336', '#9C27B0',
            '#00ACC1', '#7CB342', '#C0392B', '#D35400', '#16A085',
            '#8E44AD', '#27AE60', '#2980B9', '#F1C40F', '#34495E'
        ];

        let scheduleData = [];
        let serviceItems = [];
        let personColorMap = new Map();
        let allPersonNames = new Set();
        let displayConfig = null;
        let visibleGroups = {}; // 記錄各群組的顯示狀態

        async function init() {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);

                // 載入資料
                await loadData(db);

                // 建立顏色映射
                buildColorMap();

                // 載入分組設定並初始化過濾器
                await loadDisplayConfig(db);
                initGroupFilter();

                // 渲染表格
                renderTable();
            } catch (error) {
                console.error('初始化失敗:', error);
            }
        }

        async function loadData(db) {
            // 載入 metadata
            const metadataRef = doc(db, collectionName, '_metadata');
            const metadataDoc = await getDoc(metadataRef);
            if (metadataDoc.exists()) {
                serviceItems = metadataDoc.data().serviceItems || [];
            }

            // 載入班表資料
            const snapshot = await getDocs(collection(db, collectionName));
            scheduleData = [];

            snapshot.forEach(doc => {
                if (doc.id !== '_metadata') {
                    const data = doc.data();
                    scheduleData.push({ date: doc.id, ...data });

                    // 收集人名
                    serviceItems.forEach(service => {
                        if (data[service]) {
                            data[service].forEach(name => allPersonNames.add(name));
                        }
                    });
                }
            });

            // 按日期排序
            scheduleData.sort((a, b) => a.date.localeCompare(b.date));
        }

        function buildColorMap() {
            const sortedNames = Array.from(allPersonNames).sort();
            sortedNames.forEach((name, index) => {
                personColorMap.set(name, PERSON_CHIP_COLORS[index % PERSON_CHIP_COLORS.length]);
            });
        }

        function getPersonColor(name) {
            return personColorMap.get(name) || '#888888';
        }

        function renderTable() {
            renderTableHead();
            renderTableBody();
        }

        // 載入分組設定
        async function loadDisplayConfig(db) {
            try {
                const metadataRef = doc(db, collectionName, '_metadata');
                const metadataDoc = await getDoc(metadataRef);

                if (metadataDoc.exists() && metadataDoc.data().displayConfig) {
                    displayConfig = metadataDoc.data().displayConfig;
                } else {
                    displayConfig = null;
                }
            } catch (error) {
                console.error('載入分組設定失敗:', error);
            }
        }

        // 初始化分組過濾器
        function initGroupFilter() {
            const filterContainer = document.getElementById('groupFilter');

            // 檢查是否有分組設定且有非 ungrouped 的群組
            if (!displayConfig || !displayConfig.groups) {
                filterContainer.style.display = 'none';
                return;
            }

            const nonUngroupedGroups = displayConfig.groups.filter(g => g.id !== 'ungrouped' && g.items.length > 0);

            if (nonUngroupedGroups.length === 0) {
                filterContainer.style.display = 'none';
                return;
            }

            // 顯示過濾器
            filterContainer.style.display = 'flex';

            // 初始化各群組的顯示狀態
            displayConfig.groups.forEach(group => {
                visibleGroups[group.id] = group.defaultVisible !== false;
            });

            // 渲染 checkbox
            let html = '';
            nonUngroupedGroups.forEach(group => {
                const checked = visibleGroups[group.id] ? 'checked' : '';
                html += `
                    <label class="group-filter-item">
                        <input type="checkbox" ${checked} data-group-id="${group.id}" onchange="window.handleGroupFilterChange(this)">
                        ${group.name}
                    </label>
                `;
            });
            filterContainer.innerHTML = html;
        }

        // 處理群組過濾器變更
        window.handleGroupFilterChange = function (checkbox) {
            const groupId = checkbox.dataset.groupId;
            visibleGroups[groupId] = checkbox.checked;
            renderTable();
        };

        // 取得可見的服事項目
        function getVisibleServiceItems() {
            if (!displayConfig || !displayConfig.groups) {
                return serviceItems;
            }

            const visible = [];

            displayConfig.groups.forEach(group => {
                // ungrouped 始終顯示，其他根據勾選狀態
                if (group.id === 'ungrouped' || visibleGroups[group.id]) {
                    visible.push(...group.items);
                }
            });

            // 結合隱藏的項目過濾
            const hidden = displayConfig.hidden || [];
            return visible.filter(item => !hidden.includes(item));
        }

        // 更新的 renderTableHead
        function renderTableHead() {
            const thead = document.getElementById('tableHead');
            const visibleItems = getVisibleServiceItems();

            let html = '<tr><th class="date-header">日期</th>';
            visibleItems.forEach(item => {
                html += `<th class="service-header">${item}</th>`;
            });
            html += '</tr>';
            thead.innerHTML = html;
        }

        // 更新的 renderTableBody
        function renderTableBody() {
            const tbody = document.getElementById('tableBody');
            const visibleItems = getVisibleServiceItems();
            let html = '';

            scheduleData.forEach(row => {
                html += '<tr>';
                html += `<td><div class="date-cell">${row.date}</div></td>`;

                visibleItems.forEach(item => {
                    const persons = row[item] || [];
                    html += '<td class="service-cell">';
                    if (persons.length > 0) {
                        html += '<div class="person-chips">';
                        persons.forEach(person => {
                            const color = getPersonColor(person);
                            html += `<div class="person-chip" style="background: ${color};">${person}</div>`;
                        });
                        html += '</div>';
                    }
                    html += '</td>';
                });

                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        init();
    </script>
</body>

</html>