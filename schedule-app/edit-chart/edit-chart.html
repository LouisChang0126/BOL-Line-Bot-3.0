<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•™æœƒæœäº‹ç­è¡¨ç³»çµ±</title>
  <link rel="stylesheet" href="../styles.css">
</head>

<body>
  <div class="app-container">
    <!-- é ‚éƒ¨æ§åˆ¶å€ (åˆä½µæ¨™é¡Œèˆ‡æ§åˆ¶é¢æ¿) -->
    <div class="header-section">
      <div class="app-title">
        <a href="index.html" class="btn btn-secondary" style="margin-right: 12px; padding: 6px 12px;">â† è¿”å›</a>
        <h1 style="display: inline;">â›ª <span id="collectionTitle">æ•™æœƒæœäº‹ç­è¡¨</span></h1>
      </div>

      <div class="control-actions">
        <button class="btn btn-secondary" id="showPastBtn" style="display: none;" onclick="togglePastData()">
          ğŸ“… é¡¯ç¤ºæ­·å²è³‡æ–™
        </button>
        <button class="btn btn-secondary" id="undoBtn" title="ä¸Šä¸€æ­¥ (Ctrl+Z)" disabled>
          â¬…ï¸ ä¸Šä¸€æ­¥
        </button>
        <button class="btn btn-secondary" id="redoBtn" title="ä¸‹ä¸€æ­¥ (Ctrl+Y)" disabled>
          â¡ï¸ ä¸‹ä¸€æ­¥
        </button>
        <button class="btn btn-primary" id="addRowBtn">
          â• æ–°å¢ä¸€é€±
        </button>
        <button class="btn btn-danger" id="deleteLastRowBtn">
          â– åˆªé™¤æœ€å¾Œä¸€é€±
        </button>
        <button class="btn btn-secondary" id="addServiceBtn">
          âœ¨ æ–°å¢æœäº‹é …ç›®
        </button>
        <button class="btn btn-secondary" id="editDisplayConfigBtn">
          ğŸ“Š ç·¨è¼¯é¡¯ç¤ºæ¬„ä½
        </button>
        <button class="btn btn-secondary" id="viewLogsBtn">
          ğŸ“œ ç·¨è¼¯è¨˜éŒ„
        </button>
        <button class="btn btn-secondary btn-with-badge" id="manageUsersBtn">
          ğŸ‘¥ ç®¡ç†ä½¿ç”¨è€…
          <span class="badge-alert hidden" id="userAlertBadge">!</span>
        </button>
      </div>

      <div class="status-indicator">
        <div class="text-muted" id="statusText">è¼‰å…¥ä¸­...</div>
      </div>
    </div>

    <!-- è¡¨æ ¼å®¹å™¨ -->
    <div class="table-container">
      <div class="table-scroll">
        <table class="schedule-table" id="scheduleTable">
          <thead id="tableHead">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
          </thead>
          <tbody id="tableBody">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- å³éµé¸å–® -->
    <div class="context-menu hidden" id="contextMenu">
      <div class="context-menu-item" id="contextMenuPaste">ğŸ“‹ å¾æ­¤æ ¼è²¼ä¸Š</div>
    </div>
  </div>

  <!-- ç·¨è¼¯æœäº‹é …ç›®å°è©±æ¡† -->
  <div class="modal-overlay hidden" id="editServiceModal">
    <div class="modal">
      <div class="modal-header">
        <h2>ç·¨è¼¯æœäº‹é …ç›®</h2>
        <button class="modal-close" onclick="closeModal('editServiceModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>æœäº‹é …ç›®åç¨±</label>
          <input type="text" class="form-control" id="serviceNameInput" placeholder="è«‹è¼¸å…¥æœäº‹é …ç›®åç¨±">
        </div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button class="btn btn-danger" id="deleteServiceBtn">ç§»é™¤æœäº‹é …ç›®</button>
        <div style="display: flex; gap: 16px;">
          <button class="btn btn-secondary" onclick="closeModal('editServiceModal')">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="saveServiceBtn">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯äººå“¡å°è©±æ¡† -->
  <div class="modal-overlay hidden" id="editPersonModal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h2>ç·¨è¼¯æœäº‹äººå“¡</h2>
          <div class="modal-subtitle" id="editPersonModalSubtitle">
            <!-- å‹•æ…‹é¡¯ç¤ºæ—¥æœŸå’Œæœäº‹é …ç›® -->
          </div>
        </div>
        <button class="modal-close" onclick="closeModal('editPersonModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>é¸æ“‡ç¾æœ‰äººå“¡æˆ–è¼¸å…¥æ–°äººå“¡</label>
          <div class="person-select-container" id="personSelectContainer">
            <!-- å‹•æ…‹ç”Ÿæˆçš„ç¾æœ‰äººå“¡ç©æœ¨ -->
            <div class="person-chips-select" id="personDropdown">
              <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <!-- è¼¸å…¥æ–°äººå“¡çš„ç©ºç™½ç©æœ¨ -->
            <div class="person-chip-input-wrapper">
              <input type="text" class="person-chip-input" id="newPersonInput" placeholder="è¼¸å…¥æ–°å§“å...">
              <button class="person-chip-input-btn" id="addPersonChipBtn">+</button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>ç›®å‰æœäº‹äººå“¡</label>
          <div class="person-chips" id="currentPersonChips">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeModal('editPersonModal')">å®Œæˆ</button>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯é¡¯ç¤ºæ¬„ä½å°è©±æ¡† -->
  <div class="modal-overlay hidden" id="displayConfigModal">
    <div class="modal" style="max-width: 800px; max-height: 80vh;">
      <div class="modal-header">
        <h2>ğŸ“Š ç·¨è¼¯é¡¯ç¤ºæ¬„ä½</h2>
        <button class="modal-close" onclick="closeModal('displayConfigModal')">&times;</button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: 60vh;">
        <!-- ç¾¤çµ„å€åŸŸ -->
        <div id="displayConfigGroups" class="display-config-groups">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <!-- æ–°å¢ç¾¤çµ„æŒ‰éˆ• -->
        <div class="add-group-section">
          <button class="btn btn-secondary" id="addGroupBtn" style="width: 100%;">
            â• æ–°å¢ç¾¤çµ„
          </button>
        </div>

        <!-- ä¸é¡¯ç¤ºå€åŸŸ -->
        <div class="hidden-zone" id="hiddenZone">
          <div class="hidden-zone-title">ğŸš« ä¸é¡¯ç¤ºå€åŸŸ (æ‹–å…¥æ­¤è™•çš„é …ç›®æœƒéš±è—)</div>
          <div class="hidden-zone-items" id="hiddenZoneItems">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('displayConfigModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="saveDisplayConfigBtn">å„²å­˜è¨­å®š</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ– Firebase...');

    // å¼•å…¥ Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js';
    import { getFirestore, collection, doc, getDocs, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // å¼•å…¥é…ç½®
    import { firebaseConfig, COLLECTION_NAME } from '../firebase-config.js';

    // å¾ URL åƒæ•¸å–å¾— collection åç¨±
    const urlParams = new URLSearchParams(window.location.search);
    const collectionName = urlParams.get('collection') || '';

    // é¡¯ç¤ºéŒ¯èª¤é é¢
    function showError(title, message) {
      document.querySelector('.app-container').innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50vh; text-align: center;">
          <h1 style="color: #ef4444; font-size: 48px; margin-bottom: 16px;">âš ï¸</h1>
          <h2 style="color: #ef4444; margin-bottom: 8px;">${title}</h2>
          <p style="color: #64748b;">${message}</p>
          <a href="index.html" class="btn btn-primary" style="margin-top: 24px;">è¿”å›é¸æ“‡é é¢</a>
        </div>
      `;
    }

    // è¼‰å…¥å´‡æ‹œåˆ—è¡¨ä¸¦é©—è­‰
    async function loadAndValidateCollection(db) {
      const { doc, getDoc } = window.firestore;
      const serveListRef = doc(db, '_config', 'serve-list');
      const serveListDoc = await getDoc(serveListRef);

      if (!serveListDoc.exists()) {
        showError('å°šæœªè¨­å®š', 'è«‹å…ˆåˆ°ç®¡ç†é é¢æ–°å¢å´‡æ‹œ');
        return null;
      }

      const serveList = serveListDoc.data().serves || [];
      if (serveList.length === 0) {
        showError('å°šæœªè¨­å®š', 'è«‹å…ˆåˆ°ç®¡ç†é é¢æ–°å¢å´‡æ‹œ');
        return null;
      }

      // æª¢æŸ¥ collection æ˜¯å¦æœ‰æ•ˆ
      const serve = serveList.find(s => s.id === collectionName);
      if (!serve) {
        showError('æ‰¾ä¸åˆ°ç­è¡¨', `ç„¡æ•ˆçš„ç­è¡¨åç¨±: ${collectionName || '(æœªæŒ‡å®š)'}`);
        return null;
      }

      return serve;
    }

    // æ›´æ–°é é¢æ¨™é¡Œï¼ˆåœ¨é©—è­‰æˆåŠŸå¾Œå‘¼å«ï¼‰
    function updatePageTitle(serve) {
      document.getElementById('collectionTitle').textContent = serve.name + 'ç­è¡¨';
      document.title = `${serve.name}ç­è¡¨ - æ•™æœƒæœäº‹ç­è¡¨ç³»çµ±`;
    }

    // è¨˜éŒ„é€²å…¥é é¢çš„æ™‚é–“
    const sessionStartTime = new Date();
    const formatSessionTime = (date) => {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      const h = String(date.getHours()).padStart(2, '0');
      const min = String(date.getMinutes()).padStart(2, '0');
      return `${y}.${m}.${d}.${h}.${min}`;
    };
    window.SESSION_START_TIME = formatSessionTime(sessionStartTime);

    console.log('ğŸ“ Firebase é…ç½®:', {
      projectId: firebaseConfig.projectId,
      authDomain: firebaseConfig.authDomain,
      collectionName: collectionName
    });

    // åˆå§‹åŒ– Firebaseï¼ˆä½¿ç”¨ async IIFEï¼‰
    (async function initFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        console.log('âœ… Firebase App åˆå§‹åŒ–æˆåŠŸ');

        // åˆå§‹åŒ– App Check
        const appCheck = initializeAppCheck(app, {
          provider: new ReCaptchaV3Provider('6LcrTEgsAAAAALHsL8i7xFOrUM4t4q5j1gVftmAx'),
          isTokenAutoRefreshEnabled: true
        });

        const db = getFirestore(app);
        console.log('âœ… Firestore é€£æ¥æˆåŠŸ');

        // å°‡å…¨åŸŸè®Šæ•¸æ›è¼‰åˆ° window
        window.db = db;
        window.firestore = { collection, doc, getDocs, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, limit };
        window.COLLECTION_NAME = collectionName;

        console.log('âœ… Firebase å…¨åŸŸè®Šæ•¸å·²è¨­å®š');

        // é©—è­‰ collection æ˜¯å¦æœ‰æ•ˆ
        const serve = await loadAndValidateCollection(db);
        if (!serve) {
          return; // é©—è­‰å¤±æ•—ï¼ŒshowError å·²é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        }

        // æ›´æ–°é é¢æ¨™é¡Œ
        updatePageTitle(serve);

        // è¼‰å…¥ä¸»è¦æ‡‰ç”¨ç¨‹å¼ï¼ˆå–®ä¸€æª”æ¡ˆ app.jsï¼‰
        import('./app.js').then(() => {
          console.log('âœ… app.js å·²è¼‰å…¥');
        }).catch(error => {
          console.error('âŒ è¼‰å…¥æ‡‰ç”¨ç¨‹å¼å¤±æ•—:', error);
          document.getElementById('statusText').textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase é…ç½®';
        });
      } catch (error) {
        console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', error);
        console.error('éŒ¯èª¤è©³æƒ…:', {
          name: error.name,
          message: error.message,
          code: error.code
        });
        document.getElementById('statusText').textContent = 'Firebase åˆå§‹åŒ–å¤±æ•—';
        alert(`Firebase åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}\n\nè«‹æª¢æŸ¥ firebase-config.js ä¸­çš„é…ç½®æ˜¯å¦æ­£ç¢ºã€‚`);
      }
    })();
  </script>
</body>

</html>