<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™æœƒæœäº‹ç­è¡¨ç³»çµ±</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .selection-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px;
            position: relative;
        }

        .top-right-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            padding: 10px 16px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .top-right-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .selection-title {
            text-align: center;
            margin-bottom: 48px;
        }

        .selection-title h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .selection-title p {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .collection-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            justify-content: center;
            max-width: 1100px;
        }

        .collection-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px 48px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: var(--shadow-md);
            min-width: 200px;
            position: relative;
        }

        .collection-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .collection-card .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .collection-card .name {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .collection-card .description {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* æ–°å¢å´‡æ‹œå¡ç‰‡ */
        .collection-card.add-card {
            border: 2px dashed var(--border-color);
            background: var(--bg-secondary);
        }

        .collection-card.add-card:hover {
            border-color: var(--primary-color);
        }

        .collection-card.add-card .icon {
            color: var(--text-secondary);
        }

        /* ç·¨è¼¯/åˆªé™¤æŒ‰éˆ• */
        .card-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .collection-card:hover .card-actions {
            opacity: 1;
        }

        .card-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            background: var(--bg-secondary);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .card-action-btn:hover {
            background: var(--bg-hover);
        }

        .card-action-btn.delete:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .loading-message {
            text-align: center;
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Emoji é¸æ“‡å™¨ */
        .emoji-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .emoji-option {
            width: 48px;
            height: 48px;
            font-size: 28px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .emoji-option:hover {
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .emoji-option.selected {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        /* è­¦å‘Š Modal */
        .warning-modal .modal {
            max-width: 500px;
        }

        .warning-text {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            color: #991b1b;
        }

        .confirm-input {
            margin-top: 16px;
        }

        .confirm-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="selection-page">
        <a href="edit-user.html" class="top-right-btn">ğŸ‘¥ æ‰€æœ‰ä½¿ç”¨è€…ç®¡ç†</a>
        <div class="selection-title">
            <h1>â›ª æ•™æœƒæœäº‹ç­è¡¨ç³»çµ±</h1>
            <p>è«‹é¸æ“‡è¦ç·¨è¼¯çš„ç­è¡¨</p>
        </div>

        <div class="collection-cards" id="collectionCards">
            <div class="loading-message">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯å´‡æ‹œ Modal -->
    <div class="modal-overlay hidden" id="serveModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="serveModalTitle">æ–°å¢å´‡æ‹œ</h2>
                <button class="modal-close" onclick="closeModal('serveModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>é¸æ“‡ Emoji</label>
                    <div class="emoji-picker" id="emojiPicker">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="form-group">
                    <label>å´‡æ‹œåç¨±</label>
                    <input type="text" class="form-control" id="serveNameInput" placeholder="ä¾‹å¦‚ï¼šé’å¹´å´‡æ‹œ" maxlength="20">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('serveModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveServeBtn">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèª Modal -->
    <div class="modal-overlay hidden warning-modal" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2>âš ï¸ åˆªé™¤å´‡æ‹œ</h2>
                <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-text">
                    <strong>è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯å¾©åŸï¼</strong><br><br>
                    åˆªé™¤å¾Œï¼Œè©²å´‡æ‹œçš„æ‰€æœ‰ç­è¡¨è³‡æ–™ã€éæœŸè³‡æ–™ã€ç·¨è¼¯è¨˜éŒ„éƒ½å°‡æ°¸ä¹…åˆªé™¤ã€‚
                </div>
                <p>æ‚¨å³å°‡åˆªé™¤ï¼š<strong id="deleteServeName"></strong></p>
                <div class="confirm-input">
                    <label>è«‹è¼¸å…¥å´‡æ‹œåç¨±ä»¥ç¢ºèªåˆªé™¤ï¼š</label>
                    <input type="text" class="form-control" id="deleteConfirmInput" placeholder="">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">å–æ¶ˆ</button>
                <button class="btn btn-danger" id="confirmDeleteBtn" disabled>ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js';
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { firebaseConfig } from '../firebase-config.js';

        // 10å€‹é©åˆçš„ Emoji
        const AVAILABLE_EMOJIS = ['â›ª', 'ğŸ¸', 'ğŸ§’', 'ğŸ‘¥', 'ğŸµ', 'ğŸ“–', 'ğŸ™', 'âœï¸', 'ğŸ•Šï¸', 'ğŸ’’'];

        const MAX_SERVES = 5;

        let db;
        let serveList = []; // { id, name, emoji }
        let editingServeId = null; // ç·¨è¼¯ä¸­çš„å´‡æ‹œ ID
        let selectedEmoji = AVAILABLE_EMOJIS[0];
        let deleteTargetId = null;
        let deleteTargetName = null; // ç”¨æ–¼åˆªé™¤ç¢ºèª

        async function init() {
            try {
                const app = initializeApp(firebaseConfig);

                // åˆå§‹åŒ– App Check
                const appCheck = initializeAppCheck(app, {
                    provider: new ReCaptchaV3Provider('6LcrTEgsAAAAALHsL8i7xFOrUM4t4q5j1gVftmAx'),
                    isTokenAutoRefreshEnabled: true
                });

                db = getFirestore(app);

                // è¼‰å…¥ serve-listï¼ˆå¦‚æœä¸å­˜åœ¨å‰‡ä½¿ç”¨é è¨­å€¼ï¼Œä½†ä¸ä¸»å‹•å»ºç«‹ï¼‰
                await loadServeList();

                // æ¸²æŸ“å¡ç‰‡
                renderCollectionCards();

                // è¨­å®šäº‹ä»¶
                setupEventListeners();

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                document.getElementById('collectionCards').innerHTML =
                    '<div class="loading-message">è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>';
            }
        }

        async function loadServeList() {
            const serveListRef = doc(db, '_config', 'serve-list');
            const serveListDoc = await getDoc(serveListRef);

            if (serveListDoc.exists()) {
                serveList = serveListDoc.data().serves || [];
            } else {
                // _config ä¸å­˜åœ¨ï¼Œå…è¨±æ–°å¢ç¬¬ä¸€å€‹å´‡æ‹œ
                serveList = [];
            }
        }

        async function saveServeList() {
            const serveListRef = doc(db, '_config', 'serve-list');
            await setDoc(serveListRef, { serves: serveList });
        }

        function renderCollectionCards() {
            const container = document.getElementById('collectionCards');
            let html = '';

            // ç¾æœ‰å´‡æ‹œå¡ç‰‡
            serveList.forEach(serve => {
                html += `
                    <div class="collection-card" data-id="${serve.id}">
                        <div class="card-actions">
                            <button class="card-action-btn edit" data-id="${serve.id}" title="ç·¨è¼¯">âœï¸</button>
                            <button class="card-action-btn delete" data-id="${serve.id}" title="åˆªé™¤">ğŸ—‘ï¸</button>
                        </div>
                        <div class="icon">${serve.emoji}</div>
                        <div class="name">${serve.name}</div>
                    </div>
                `;
            });

            // æ–°å¢å´‡æ‹œå¡ç‰‡ï¼ˆæœ€å¤š5å ´ï¼‰
            if (serveList.length < MAX_SERVES) {
                html += `
                    <div class="collection-card add-card" id="addServeCard">
                        <div class="icon">â•</div>
                        <div class="name">æ–°å¢å´‡æ‹œ</div>
                        <div class="description">æœ€å¤š ${MAX_SERVES} å ´</div>
                    </div>
                `;
            }

            container.innerHTML = html;

            // ç¶å®šå¡ç‰‡é»æ“Šäº‹ä»¶ï¼ˆé€²å…¥ç­è¡¨ï¼‰
            container.querySelectorAll('.collection-card:not(.add-card)').forEach(card => {
                card.addEventListener('click', (e) => {
                    // å¦‚æœé»æ“Šçš„æ˜¯ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•ï¼Œä¸è·³è½‰
                    if (e.target.closest('.card-action-btn')) return;
                    const id = card.dataset.id;
                    window.location.href = `edit-chart.html?collection=${id}`;
                });
            });

            // ç¶å®šæ–°å¢å¡ç‰‡
            const addCard = document.getElementById('addServeCard');
            if (addCard) {
                addCard.addEventListener('click', openAddServeModal);
            }

            // ç¶å®šç·¨è¼¯æŒ‰éˆ•
            container.querySelectorAll('.card-action-btn.edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.dataset.id;
                    openEditServeModal(id);
                });
            });

            // ç¶å®šåˆªé™¤æŒ‰éˆ•
            container.querySelectorAll('.card-action-btn.delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.dataset.id;
                    openDeleteModal(id);
                });
            });
        }

        function renderEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.innerHTML = AVAILABLE_EMOJIS.map(emoji => `
                <button class="emoji-option ${emoji === selectedEmoji ? 'selected' : ''}" data-emoji="${emoji}">
                    ${emoji}
                </button>
            `).join('');

            // ç¶å®šé»æ“Šäº‹ä»¶
            picker.querySelectorAll('.emoji-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedEmoji = btn.dataset.emoji;
                    picker.querySelectorAll('.emoji-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });
        }

        function openAddServeModal() {
            editingServeId = null;
            selectedEmoji = AVAILABLE_EMOJIS[0];

            document.getElementById('serveModalTitle').textContent = 'æ–°å¢å´‡æ‹œ';
            document.getElementById('serveNameInput').value = '';

            renderEmojiPicker();
            document.getElementById('serveModal').classList.remove('hidden');
        }

        function openEditServeModal(id) {
            const serve = serveList.find(s => s.id === id);
            if (!serve) return;

            editingServeId = id;
            selectedEmoji = serve.emoji;

            document.getElementById('serveModalTitle').textContent = 'ç·¨è¼¯å´‡æ‹œ';
            document.getElementById('serveNameInput').value = serve.name;

            renderEmojiPicker();
            document.getElementById('serveModal').classList.remove('hidden');
        }

        function openDeleteModal(id) {
            const serve = serveList.find(s => s.id === id);
            if (!serve) return;

            deleteTargetId = id;
            deleteTargetName = serve.name;
            document.getElementById('deleteServeName').textContent = `${serve.emoji} ${serve.name}`;
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('deleteConfirmInput').placeholder = serve.name;
            document.getElementById('confirmDeleteBtn').disabled = true;

            document.getElementById('deleteModal').classList.remove('hidden');
        }

        window.closeModal = function (modalId) {
            document.getElementById(modalId).classList.add('hidden');
            editingServeId = null;
            deleteTargetId = null;
            deleteTargetName = null;
        };

        function setupEventListeners() {
            // å„²å­˜å´‡æ‹œ
            document.getElementById('saveServeBtn').addEventListener('click', saveServe);

            // åˆªé™¤ç¢ºèªè¼¸å…¥ï¼ˆæ¯”å°åç¨±ï¼‰
            document.getElementById('deleteConfirmInput').addEventListener('input', (e) => {
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                confirmBtn.disabled = e.target.value !== deleteTargetName;
            });

            // ç¢ºèªåˆªé™¤
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteServe);

            // Enter éµå„²å­˜
            document.getElementById('serveNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveServe();
            });
        }

        // å–å¾—å¯ç”¨çš„å´‡æ‹œ IDï¼ˆ_service_1 åˆ° _service_5ï¼‰
        function getAvailableServiceId() {
            const usedIds = serveList.map(s => s.id);
            for (let i = 1; i <= 5; i++) {
                const id = `_service_${i}`;
                if (!usedIds.includes(id)) {
                    return id;
                }
            }
            return null; // å…¨éƒ¨ç”¨å®Œ
        }

        async function saveServe() {
            const name = document.getElementById('serveNameInput').value.trim();

            if (!name) {
                alert('è«‹è¼¸å…¥å´‡æ‹œåç¨±');
                return;
            }

            // æª¢æŸ¥åç¨±æ˜¯å¦é‡è¤‡ï¼ˆæ’é™¤è‡ªå·±ï¼‰
            if (serveList.some(s => s.name === name && s.id !== editingServeId)) {
                alert('æ­¤å´‡æ‹œåç¨±å·²å­˜åœ¨');
                return;
            }

            if (!editingServeId) {
                // æ–°å¢æ¨¡å¼
                const id = getAvailableServiceId();
                if (!id) {
                    alert('å·²é”åˆ°æœ€å¤§å´‡æ‹œæ•¸é‡é™åˆ¶');
                    return;
                }

                // æ–°å¢
                serveList.push({ id, name, emoji: selectedEmoji });

                // å»ºç«‹ _metadata
                try {
                    const metadataRef = doc(db, id, '_metadata');
                    await setDoc(metadataRef, { serviceItems: [] });
                } catch (error) {
                    console.error('å»ºç«‹ _metadata å¤±æ•—:', error);
                }

            } else {
                // ç·¨è¼¯æ¨¡å¼ï¼šåªæ”¹ name å’Œ emojiï¼Œä¸æ”¹ id
                const serve = serveList.find(s => s.id === editingServeId);
                if (!serve) return;

                serve.name = name;
                serve.emoji = selectedEmoji;
            }

            await saveServeList();
            closeModal('serveModal');
            renderCollectionCards();
        }

        async function deleteServe() {
            if (!deleteTargetId) return;

            const confirmInput = document.getElementById('deleteConfirmInput').value;
            if (confirmInput !== deleteTargetName) {
                alert('è¼¸å…¥çš„å´‡æ‹œåç¨±ä¸æ­£ç¢º');
                return;
            }

            try {
                // åˆªé™¤ä¸» collection çš„æ‰€æœ‰ documents
                const mainCollectionRef = collection(db, deleteTargetId);
                const mainDocs = await getDocs(mainCollectionRef);
                const batch1 = writeBatch(db);
                mainDocs.forEach(docRef => {
                    batch1.delete(docRef.ref);
                });
                await batch1.commit();

                // åˆªé™¤ Expired collection
                try {
                    const expiredCollectionRef = collection(db, `Expired-${deleteTargetId}`);
                    const expiredDocs = await getDocs(expiredCollectionRef);
                    if (!expiredDocs.empty) {
                        const batch2 = writeBatch(db);
                        expiredDocs.forEach(docRef => {
                            batch2.delete(docRef.ref);
                        });
                        await batch2.commit();
                    }
                } catch (e) {
                    console.log('Expired collection ä¸å­˜åœ¨æˆ–åˆªé™¤å¤±æ•—');
                }

                // å¾ serveList ç§»é™¤
                serveList = serveList.filter(s => s.id !== deleteTargetId);
                await saveServeList();

                closeModal('deleteModal');
                renderCollectionCards();
                alert('å·²æˆåŠŸåˆªé™¤å´‡æ‹œ');

            } catch (error) {
                console.error('åˆªé™¤å´‡æ‹œå¤±æ•—:', error);
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        init();
    </script>
</body>

</html>